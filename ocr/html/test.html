<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoVerify 驗證碼辨識測試</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:24px; align-items:flex-start; }
    .box { border:1px solid #ddd; border-radius:8px; padding:16px; }
    #preview { max-width:360px; max-height:120px; object-fit:contain; background:#fafafa; border:1px dashed #ccc; }
    #result { font-size:20px; font-weight:600; color:#111; }
    .muted { color:#666; }
    button { padding:8px 14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
  </style>
</head>
<body>
  <h1>AutoVerify 驗證碼辨識測試（精簡版）</h1>
  <p class="muted">此頁面直接使用 js/ocr.js 的函式：ocr(dataUrl) => Promise&lt;string&gt;。</p>

  <div class="row">
    <div class="box">
      <div style="margin-bottom:12px;">
        <input id="file" type="file" accept="image/*" />
        <button id="demoBtn" type="button">載入示例圖片</button>
      </div>
      <img id="preview" alt="預覽" />
    </div>
    <div class="box" style="min-width:280px;">
      <div>辨識結果：</div>
      <div id="result">—</div>
      <div id="status" class="muted" style="margin-top:8px;">等待圖片...</div>
    </div>
  </div>

  <script src="../js/ocr.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const previewEl = document.getElementById('preview');
    let lastObjectUrl = null;
    const setStatus = (t)=> statusEl.textContent = t;

    async function fileToDataUrl(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> reject(new Error('讀取檔案失敗'));
        fr.readAsDataURL(file);
      });
    }

    async function recognizeDataUrl(dataUrl){
      if (!dataUrl) return;
      setStatus('推論中...');
      try {
        if (typeof window.ocr !== 'function') {
          throw new Error('OCR 尚未載入');
        }
        const text = await window.ocr(dataUrl);
        resultEl.textContent = text || '（空）';
        setStatus('完成');
      } catch (e) {
        resultEl.textContent = '—';
        setStatus('錯誤：' + (e?.message || e));
        console.error(e);
      }
    }

    document.getElementById('file').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
      const url = URL.createObjectURL(file);
      lastObjectUrl = url;
      previewEl.src = url;
      const dataUrl = await fileToDataUrl(file);
      recognizeDataUrl(dataUrl);
    });

    document.getElementById('demoBtn').addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = 140; canvas.height = 50;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#f3f3f3';
      ctx.fillRect(0,0,canvas.width, canvas.height);
      ctx.font = '28px monospace';
      ctx.fillStyle = '#222';
      const text = 'AB12';
      ctx.fillText(text, 20, 35);
      const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
      if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
      const url = URL.createObjectURL(blob);
      lastObjectUrl = url;
      previewEl.src = url;
      const dataUrl = await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); });
      recognizeDataUrl(dataUrl);
    });

    // 預先初始化 ORM 與模型（暖機），可觀察 Network 有無載入 o.min.js / model.bin / wasm
    (async () => {
      try {
        // 用 1x1 透明像素暖機，僅為了觸發載入相依資源
        const tiny = 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';
        await recognizeDataUrl(tiny);
      } catch (e) {
        console.warn('Warmup failed (可忽略)：', e);
      }
    })();
  </script>
</body>
</html>
